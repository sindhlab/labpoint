<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sindh Lab Point - Management System (Updated)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
  <style>
    :root {
      --primary: #2c3e50;
      --secondary: #3498db;
      --accent: #e74c3c;
      --light: #ecf0f1;
      --dark: #2c3e50;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f8f9fa;
      color: #333;
    }

    .sidebar {
      background-color: var(--primary);
      color: white;
      height: 100vh;
      position: fixed;
      padding-top: 20px;
      overflow-y: auto;
    }

    .sidebar a {
      color: white;
      padding: 15px 20px;
      text-decoration: none;
      display: block;
      transition: all 0.3s;
    }

    .sidebar a:hover {
      background-color: var(--secondary);
    }

    .sidebar a.active {
      background-color: var(--secondary);
      border-left: 4px solid var(--accent);
    }

    .main-content {
      margin-left: 250px;
      padding: 20px;
    }

    .card {
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
      border: none;
    }

    .card-header {
      background-color: var(--primary);
      color: white;
      border-radius: 10px 10px 0 0 !important;
    }

    .btn-primary {
      background-color: var(--secondary);
      border: none;
    }

    .btn-primary:hover {
      background-color: #2980b9;
    }

    .btn-danger {
      background-color: var(--accent);
      border: none;
    }

    .table th {
      background-color: var(--primary);
      color: white;
    }

    .page { display: none; }
    .page.active { display: block; }

    .logo {
      text-align: center;
      padding: 20px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
      margin-bottom: 20px;
    }

    .stats-box {
      text-align: center;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      color: white;
    }

    .stats-box.primary { background-color: var(--primary); }
    .stats-box.success { background-color: #27ae60; }
    .stats-box.warning { background-color: #f39c12; }
    .stats-box.danger { background-color: var(--accent); }
    .stats-box i { font-size: 24px; margin-bottom: 10px; }
    .stats-box h4 { font-size: 24px; margin: 0; }
    .stats-box p { margin: 0; opacity: 0.8; }

    /* Print styles for invoices/statements */
    @media print {
      body * { visibility: hidden; }
      .print-area, .print-area * { visibility: visible; }
      .print-area { position: absolute; left: 0; top: 0; width: 100%; }
    }

    .invoice-copy {
      border: 1px dashed #999;
      padding: 16px;
      margin-bottom: 24px;
      background: #fff;
    }

    .signature-line {
      display: flex; justify-content: space-between; gap: 24px; margin-top: 24px;
    }
    .signature-line div { flex: 1; text-align: center; }
    .signature-line .line { border-top: 1px solid #444; padding-top: 6px; margin-top: 32px; }
    
    /* Customer profile modal */
    .customer-profile-modal .modal-dialog { max-width: 800px; }
    .customer-details { background: #f8f9fa; padding: 20px; border-radius: 8px; }
  </style>
</head>
<body>
  <div class="container-fluid">
    <div class="row">
      <!-- Sidebar -->
      <div class="col-md-2 sidebar d-none d-md-block">
        <div class="logo">
          <h3><i class="fas fa-stethoscope"></i> Sindh Lab Point</h3>
          <p>Surgical Shop Management</p>
        </div>
        <a href="#" class="active" data-page="dashboard"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
        <a href="#" data-page="stock-management"><i class="fas fa-boxes"></i> Stock Management</a>
        <a href="#" data-page="add-stock"><i class="fas fa-cart-plus"></i> Add Stock</a>
        <a href="#" data-page="sale-management"><i class="fas fa-chart-line"></i> Sale Management</a>
        <a href="#" data-page="invoice"><i class="fas fa-receipt"></i> Create Invoice</a>
        <a href="#" data-page="accounts"><i class="fas fa-file-invoice-dollar"></i> Accounts (Sake)</a>
        <a href="#" data-page="customers"><i class="fas fa-user-plus"></i> Customers</a>
        <a href="#" data-page="profit-loss"><i class="fas fa-calculator"></i> Profit & Loss</a>
      </div>

      <!-- Main Content -->
      <div class="col-md-10 main-content">
        <!-- Dashboard Page -->
        <div id="dashboard" class="page active">
          <h2 class="mb-4">Dashboard</h2>
          <div class="row">
            <div class="col-md-3">
              <div class="stats-box primary">
                <i class="fas fa-boxes"></i>
                <h4 id="total-stock-items">0</h4>
                <p>Total Stock Items</p>
              </div>
            </div>
            <div class="col-md-3">
              <div class="stats-box success">
                <i class="fas fa-shopping-cart"></i>
                <h4 id="total-sales">0</h4>
                <p>Total Sales</p>
              </div>
            </div>
            <div class="col-md-3">
              <div class="stats-box warning">
                <i class="fas fa-hand-holding-usd"></i>
                <h4 id="total-profit">0 PKR</h4>
                <p>Total Profit</p>
              </div>
            </div>
            <div class="col-md-3">
              <div class="stats-box danger">
                <i class="fas fa-truck"></i>
                <h4 id="total-suppliers">0</h4>
                <p>Total Suppliers</p>
              </div>
            </div>
          </div>

          <div class="row mt-4">
            <div class="col-md-6">
              <div class="card">
                <div class="card-header"><h5 class="mb-0">Low Stock Alert</h5></div>
                <div class="card-body">
                  <div class="table-responsive">
                    <table class="table table-striped">
                      <thead>
                        <tr>
                          <th>Product</th>
                          <th>Current Stock</th>
                          <th>Action</th>
                        </tr>
                      </thead>
                      <tbody id="low-stock-table"></tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="card">
                <div class="card-header"><h5 class="mb-0">Recent Sales</h5></div>
                <div class="card-body">
                  <div class="table-responsive">
                    <table class="table table-striped">
                      <thead>
                        <tr>
                          <th>Invoice #</th>
                          <th>Customer</th>
                          <th>Amount</th>
                        </tr>
                      </thead>
                      <tbody id="recent-sales-table"></tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Stock Management Page -->
        <div id="stock-management" class="page">
          <h2 class="mb-4">Stock Management</h2>
          <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
              <h5 class="mb-0">Current Stock</h5>
              <div class="d-flex">
                <input type="text" id="stock-search" class="form-control me-2" placeholder="Search products..." />
                <button class="btn btn-light" onclick="sortStock()">Sort A-Z</button>
              </div>
            </div>
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-striped">
                  <thead>
                    <tr>
                      <th>Product ID</th>
                      <th>Product Name</th>
                      <th>Company</th>
                      <th>Quantity</th>
                      <th>Purchase Price</th>
                      <th>Sale Price</th>
                    </tr>
                  </thead>
                  <tbody id="stock-table"></tbody>
                </table>
                <div class="text-muted small">Delete option removed as requested.</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Add Stock Page -->
        <div id="add-stock" class="page">
          <h2 class="mb-4">Add Stock</h2>
          <div class="row">
            <div class="col-md-6">
              <div class="card">
                <div class="card-header"><h5 class="mb-0">Add New Stock</h5></div>
                <div class="card-body">
                  <form id="add-stock-form">
                    <div class="mb-3">
                      <label class="form-label">Company</label>
                      <div class="input-group">
                        <select class="form-select" id="company-select">
                          <option value="">Select Company</option>
                        </select>
                        <button class="btn btn-outline-secondary" type="button" id="toggle-new-company">
                          <i class="fas fa-plus"></i> New
                        </button>
                      </div>
                    </div>
                    <div class="mb-3" id="new-company-field" style="display: none;">
                      <label class="form-label">New Company Name</label>
                      <input type="text" class="form-control" id="new-company" />
                    </div>
                    <div class="mb-3">
                      <label class="form-label">Product Name</label>
                      <input type="text" class="form-control" id="product-name" required />
                    </div>
                    <div class="row">
                      <div class="col-md-6">
                        <div class="mb-3">
                          <label class="form-label">Purchase Price (PKR)</label>
                          <input type="number" class="form-control" id="purchase-price" required min="0" step="0.01" />
                        </div>
                      </div>
                      <div class="col-md-6">
                        <div class="mb-3">
                          <label class="form-label">Sale Price (PKR)</label>
                          <input type="number" class="form-control" id="sale-price" required min="0" step="0.01" />
                        </div>
                      </div>
                    </div>
                    <div class="mb-3">
                      <label class="form-label">Quantity</label>
                      <input type="number" class="form-control" id="quantity" required min="1" />
                    </div>
                    <button type="submit" class="btn btn-primary">Add Stock</button>
                  </form>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="card">
                <div class="card-header"><h5 class="mb-0">Recent Stock Added</h5></div>
                <div class="card-body">
                  <div class="table-responsive">
                    <table class="table table-striped">
                      <thead>
                        <tr>
                          <th>Product</th>
                          <th>Company</th>
                          <th>Qty</th>
                          <th>Date</th>
                        </tr>
                      </thead>
                      <tbody id="recent-stock-table"></tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Sale Management Page -->
        <div id="sale-management" class="page">
          <h2 class="mb-4">Sale Management</h2>
          <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
              <h5 class="mb-0">Sales History</h5>
              <div class="d-flex">
                <input type="date" id="start-date" class="form-control me-2" />
                <input type="date" id="end-date" class="form-control me-2" />
                <button class="btn btn-primary me-2" onclick="filterSales()">Filter</button>
                <button class="btn btn-success" onclick="printFilteredSales()"><i class="fas fa-print"></i> Print</button>
              </div>
            </div>
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-striped">
                  <thead>
                    <tr>
                      <th>Invoice #</th>
                      <th>Date/Time</th>
                      <th>Customer</th>
                      <th>Items</th>
                      <th>Total Amount</th>
                      <th>Profit</th>
                      <th>Action</th>
                    </tr>
                  </thead>
                  <tbody id="sales-table"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- Create Invoice Page -->
        <div id="invoice" class="page">
          <h2 class="mb-4">Create Invoice</h2>
          <div class="row">
            <div class="col-md-8">
              <div class="card">
                <div class="card-header"><h5 class="mb-0">Invoice Details</h5></div>
                <div class="card-body">
                  <div class="row mb-3">
                    <div class="col-md-6">
                      <label class="form-label">Select Customer</label>
                      <select class="form-select" id="customer-select">
                        <option value="">Select Customer</option>
                      </select>
                      <div class="form-text">Need a new customer? Go to <a href="#" data-page-jump="customers">Customers</a> page.</div>
                    </div>
                  </div>
                  <div class="row mb-3">
                    <div class="col-md-6">
                      <label class="form-label">Select Product</label>
                      <select class="form-select" id="product-select">
                        <option value="">Select Product</option>
                      </select>
                    </div>
                    <div class="col-md-3">
                      <label class="form-label">Quantity</label>
                      <input type="number" class="form-control" id="sale-quantity" min="1" value="1" />
                    </div>
                    <div class="col-md-3">
                      <label class="form-label">&nbsp;</label>
                      <button class="btn btn-primary w-100" onclick="addToInvoice()">Add Item</button>
                    </div>
                  </div>
                  <div class="table-responsive">
                    <table class="table table-striped">
                      <thead>
                        <tr>
                          <th>Product</th>
                          <th>Price</th>
                          <th>Quantity</th>
                          <th>Total</th>
                          <th>Action</th>
                        </tr>
                      </thead>
                      <tbody id="invoice-items"></tbody>
                      <tfoot>
                        <tr>
                          <th colspan="3" class="text-end">Total:</th>
                          <th id="invoice-total">0.00 PKR</th>
                          <th></th>
                        </tr>
                      </tfoot>
                    </table>
                  </div>
                  <div class="d-flex justify-content-end">
                    <button class="btn btn-success me-2" onclick="processSale()">Process Sale</button>
                    <button class="btn btn-secondary" onclick="clearInvoice()">Clear</button>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="card">
                <div class="card-header"><h5 class="mb-0">Recent Invoices</h5></div>
                <div class="card-body">
                  <div class="table-responsive">
                    <table class="table table-striped">
                      <thead>
                        <tr>
                          <th>Invoice #</th>
                          <th>Date</th>
                          <th>Amount</th>
                          <th></th>
                        </tr>
                      </thead>
                      <tbody id="recent-invoices-table"></tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Accounts (Sake) Page -->
        <div id="accounts" class="page">
          <h2 class="mb-4">Accounts (Sake) Management</h2>
          <div class="card">
            <div class="card-header d-flex flex-wrap gap-2 align-items-center">
              <h5 class="mb-0">Monthly Party Report</h5>
              <div class="ms-auto d-flex gap-2">
                <select class="form-select" id="accounts-month"></select>
                <select class="form-select" id="accounts-year"></select>
                <select class="form-select" id="accounts-customer"></select>
                <button class="btn btn-primary" onclick="loadAccounts()">Load</button>
                <button class="btn btn-success" onclick="printMonthlyStatement()"><i class="fas fa-print"></i> Print Monthly</button>
              </div>
            </div>
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-striped">
                  <thead>
                    <tr>
                      <th>Buyer</th>
                      <th>Purchases (PKR)</th>
                      <th>Paid (PKR)</th>
                      <th>Unpaid (PKR)</th>
                      <th>Payments (dates & amounts)</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody id="accounts-table"></tbody>
                </table>
              </div>
            </div>
          </div>
          <div id="accounts-print" class="print-area" style="display:none;"></div>
        </div>

        <!-- Customers Page -->
        <div id="customers" class="page">
          <h2 class="mb-4">Customers</h2>
          <div class="row">
            <div class="col-md-6">
              <div class="card">
                <div class="card-header"><h5 class="mb-0">Add New Customer</h5></div>
                <div class="card-body">
                  <div class="mb-3">
                    <label class="form-label">Business Name</label>
                    <input type="text" id="customer-business-name" class="form-control" placeholder="e.g., City Lab" required />
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Contact Person</label>
                    <input type="text" id="customer-contact-person" class="form-control" placeholder="e.g., Ali Ahmed" />
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Address</label>
                    <textarea id="customer-address" class="form-control" rows="2"></textarea>
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Phone Number</label>
                    <input type="text" id="customer-phone" class="form-control" placeholder="e.g., 0300-1234567" />
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Email</label>
                    <input type="email" id="customer-email" class="form-control" placeholder="e.g., info@citylab.com" />
                  </div>
                  <button class="btn btn-primary" onclick="addCustomer()">Add Customer</button>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="card">
                <div class="card-header"><h5 class="mb-0">All Customers</h5></div>
                <div class="card-body">
                  <ul id="customer-list" class="list-group"></ul>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Profit & Loss Page -->
        <div id="profit-loss" class="page">
          <h2 class="mb-4">Profit & Loss Statement</h2>
          <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
              <h5 class="mb-0">Financial Overview</h5>
              <div class="d-flex">
                <select class="form-select me-2" id="report-period" onchange="calculateProfitLoss()">
                  <option value="today">Today</option>
                  <option value="week">This Week</option>
                  <option value="month" selected>This Month</option>
                  <option value="year">This Year</option>
                  <option value="custom">Custom Range</option>
                </select>
                <div id="custom-range" style="display: none;">
                  <input type="date" id="profit-start-date" class="form-control me-2" />
                  <input type="date" id="profit-end-date" class="form-control me-2" />
                </div>
              </div>
            </div>
            <div class="card-body">
              <div class="row mb-4">
                <div class="col-md-3">
                  <div class="stats-box primary">
                    <i class="fas fa-money-bill-wave"></i>
                    <h4 id="total-revenue">0 PKR</h4>
                    <p>Total Revenue</p>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="stats-box danger">
                    <i class="fas fa-shopping-cart"></i>
                    <h4 id="total-cost">0 PKR</h4>
                    <p>Total Cost</p>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="stats-box success">
                    <i class="fas fa-chart-line"></i>
                    <h4 id="net-profit">0 PKR</h4>
                    <p>Net Profit</p>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="stats-box warning">
                    <i class="fas fa-percentage"></i>
                    <h4 id="profit-margin">0%</h4>
                    <p>Profit Margin</p>
                  </div>
                </div>
              </div>
              <div class="table-responsive">
                <table class="table table-striped">
                  <thead>
                    <tr>
                      <th>Date</th>
                      <th>Invoice #</th>
                      <th>Product</th>
                      <th>Qty</th>
                      <th>Revenue</th>
                      <th>Cost</th>
                      <th>Profit</th>
                    </tr>
                  </thead>
                  <tbody id="profit-loss-table"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Customer Profile Modal -->
  <div class="modal fade customer-profile-modal" id="customerProfileModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Customer Profile</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="customer-details mb-4">
            <h4 id="profile-customer-name"></h4>
            <p id="profile-contact-info"></p>
            <p id="profile-address"></p>
          </div>
          <div class="row mb-4">
            <div class="col-md-4">
              <div class="stats-box primary">
                <i class="fas fa-shopping-cart"></i>
                <h4 id="profile-total-purchases">0 PKR</h4>
                <p>Total Purchases</p>
              </div>
            </div>
            <div class="col-md-4">
              <div class="stats-box success">
                <i class="fas fa-money-bill-wave"></i>
                <h4 id="profile-total-paid">0 PKR</h4>
                <p>Total Paid</p>
              </div>
            </div>
            <div class="col-md-4">
              <div class="stats-box danger">
                <i class="fas fa-credit-card"></i>
                <h4 id="profile-total-unpaid">0 PKR</h4>
                <p>Unpaid Balance</p>
              </div>
            </div>
          </div>
          <h5>Purchase History</h5>
          <div class="table-responsive">
            <table class="table table-striped">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Invoice #</th>
                  <th>Amount</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody id="profile-purchase-history"></tbody>
            </table>
          </div>
          <h5>Payment History</h5>
          <div class="table-responsive">
            <table class="table table-striped">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Amount</th>
                  <th>Note</th>
                </tr>
              </thead>
              <tbody id="profile-payment-history"></tbody>
            </table>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // ===== Data storage =====
    let stock = JSON.parse(localStorage.getItem('stock')) || [];
    let sales = JSON.parse(localStorage.getItem('sales')) || [];
    let companies = JSON.parse(localStorage.getItem('companies')) || ['Medtronic', 'Johnson & Johnson', 'Becton Dickinson'];
    let customers = JSON.parse(localStorage.getItem('customers')) || [];
    let payments = JSON.parse(localStorage.getItem('payments')) || [];
    let nextInvoiceId = parseInt(localStorage.getItem('nextInvoiceId')) || 1001;
    let currentInvoiceItems = [];

    // Initialize customers if empty
    if (customers.length === 0) {
      customers = [
        { 
          id: 1, 
          businessName: 'City Lab', 
          contactPerson: 'Ahmed Khan', 
          address: 'Main Street, City Center', 
          phone: '0300-1234567', 
          email: 'info@citylab.com' 
        },
        { 
          id: 2, 
          businessName: 'Central Diagnostic', 
          contactPerson: 'Ali Raza', 
          address: 'Gulshan-e-Iqbal', 
          phone: '0312-7654321', 
          email: 'contact@centraldiagnostic.com' 
        },
        { 
          id: 3, 
          businessName: 'Health Care Lab', 
          contactPerson: 'Dr. Farhan', 
          address: 'North Nazimabad', 
          phone: '021-34567890', 
          email: 'info@healthcarelab.com' 
        }
      ];
      localStorage.setItem('customers', JSON.stringify(customers));
    }

    // ===== Helpers =====
    function fmtCurrency(n){ return (n||0).toFixed(2) + ' PKR'; }
    function todayISO(){ return new Date().toISOString(); }
    function monthName(n){ return new Date(2000, n, 1).toLocaleString(undefined,{month:'long'}); }

    // ===== Initialize =====
    document.addEventListener('DOMContentLoaded', function(){
      initializeNavigation();
      initMonthYearSelectors();
      loadDashboard();
      loadStockManagement();
      loadAddStock();
      loadSaleManagement();
      loadInvoice();
      loadCustomers();
      loadAccountsSelectors();
      calculateProfitLoss();
    });

    // ===== Navigation =====
    function showPage(id){
      document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
      document.getElementById(id).classList.add('active');
    }
    function initializeNavigation(){
      const navLinks = document.querySelectorAll('.sidebar a[data-page]');
      navLinks.forEach(link=>{
        link.addEventListener('click',function(e){
          e.preventDefault();
          const target = this.getAttribute('data-page');
          navLinks.forEach(l=>l.classList.remove('active'));
          this.classList.add('active');
          showPage(target);
          if(target==='accounts') loadAccounts();
        });
      });
      document.addEventListener('click', (e)=>{
        const jump = e.target.closest('[data-page-jump]');
        if(jump){
          e.preventDefault();
          const target = jump.getAttribute('data-page-jump');
          document.querySelectorAll('.sidebar a[data-page]').forEach(a=>{
            a.classList.toggle('active', a.getAttribute('data-page')===target);
          });
          showPage(target);
        }
      });
      
      // Toggle new company field
      document.getElementById('toggle-new-company').addEventListener('click', function(){
        const newCompanyField = document.getElementById('new-company-field');
        const companySelect = document.getElementById('company-select');
        
        if (newCompanyField.style.display === 'none') {
          newCompanyField.style.display = 'block';
          companySelect.disabled = true;
          companySelect.value = '';
        } else {
          newCompanyField.style.display = 'none';
          companySelect.disabled = false;
          document.getElementById('new-company').value = '';
        }
      });
    }

    // ===== Dashboard =====
    function loadDashboard(){
      document.getElementById('total-stock-items').textContent = stock.length;
      document.getElementById('total-sales').textContent = sales.length;
      let totalProfit = 0; sales.forEach(s=> totalProfit += (s.netProfit||0));
      document.getElementById('total-profit').textContent = fmtCurrency(totalProfit);
      document.getElementById('total-suppliers').textContent = companies.length;

      const lowStockTable = document.getElementById('low-stock-table');
      lowStockTable.innerHTML='';
      const lowStockItems = stock.filter(i=> i.quantity < 10 && i.quantity > 0);
      if(lowStockItems.length===0){ lowStockTable.innerHTML = '<tr><td colspan="3" class="text-center">No low stock items</td></tr>'; }
      else {
        lowStockItems.forEach(item=>{
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${item.name}</td><td>${item.quantity}</td><td><button class="btn btn-sm btn-primary" onclick="navigateToStock()">Restock</button></td>`;
          lowStockTable.appendChild(tr);
        });
      }

      const recentSalesTable = document.getElementById('recent-sales-table');
      recentSalesTable.innerHTML='';
      const recentSales = sales.slice(-5).reverse();
      if(recentSales.length===0){ recentSalesTable.innerHTML = '<tr><td colspan="3" class="text-center">No recent sales</td></tr>'; }
      else {
        recentSales.forEach(s=>{
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${s.invoiceId}</td><td>${s.customer}</td><td>${fmtCurrency(s.totalAmount)}</td>`;
          recentSalesTable.appendChild(tr);
        });
      }
    }
    function navigateToStock(){
      document.querySelector('.sidebar a[data-page="stock-management"]').click();
    }

    // ===== Stock Management =====
    function loadStockManagement(){
      const body = document.getElementById('stock-table');
      body.innerHTML='';
      // Filter out items with zero or negative stock
      const validStock = stock.filter(item => item.quantity > 0);
      
      if(validStock.length===0){ body.innerHTML = '<tr><td colspan="6" class="text-center">No stock items available</td></tr>'; return; }
      validStock.forEach((item, idx)=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${idx+100}</td><td>${item.name}</td><td>${item.company}</td><td>${item.quantity}</td><td>${item.purchasePrice.toFixed(2)} PKR</td><td>${item.salePrice.toFixed(2)} PKR</td>`;
        body.appendChild(tr);
      });
    }
    function sortStock(){ 
      stock.sort((a,b)=> a.name.localeCompare(b.name)); 
      localStorage.setItem('stock', JSON.stringify(stock)); 
      loadStockManagement(); 
    }

    // ===== Add Stock =====
    function loadAddStock(){
      const companySelect = document.getElementById('company-select');
      companySelect.innerHTML = '<option value="">Select Company</option>';
      companies.forEach(c=>{ const o=document.createElement('option'); o.value=c; o.textContent=c; companySelect.appendChild(o); });

      const recentStockTable = document.getElementById('recent-stock-table');
      recentStockTable.innerHTML='';
      const recentStock = stock.slice(-5).reverse();
      if(recentStock.length===0){ recentStockTable.innerHTML = '<tr><td colspan="4" class="text-center">No recent stock additions</td></tr>'; }
      else {
        recentStock.forEach(item=>{
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${item.name}</td><td>${item.company}</td><td>${item.quantity}</td><td>${new Date().toLocaleDateString()}</td>`;
          recentStockTable.appendChild(tr);
        });
      }

      document.getElementById('add-stock-form').onsubmit = function(e){
        e.preventDefault();
        let company = document.getElementById('company-select').value;
        const newCompany = document.getElementById('new-company').value.trim();
        
        // If new company is provided, use it
        if(newCompany){ 
          company = newCompany; 
          if(!companies.includes(newCompany)){ 
            companies.push(newCompany); 
            localStorage.setItem('companies', JSON.stringify(companies)); 
          } 
        }
        
        // Validate company selection
        if(!company) {
          alert('Please select or enter a company name');
          return;
        }
        
        const productName = document.getElementById('product-name').value.trim();
        const purchasePrice = parseFloat(document.getElementById('purchase-price').value);
        const salePrice = parseFloat(document.getElementById('sale-price').value);
        const quantity = parseInt(document.getElementById('quantity').value);

        // Check if product already exists
        const existingProduct = stock.find(p => p.name.toLowerCase() === productName.toLowerCase() && p.company === company);
        if(existingProduct){
          existingProduct.quantity += quantity;
          existingProduct.purchasePrice = purchasePrice;
          existingProduct.salePrice = salePrice;
        } else {
          stock.push({ id: stock.length+1, name: productName, company, purchasePrice, salePrice, quantity });
        }
        
        localStorage.setItem('stock', JSON.stringify(stock));
        alert('Stock added successfully!');
        this.reset();
        document.getElementById('new-company-field').style.display = 'none';
        document.getElementById('company-select').disabled = false;
        loadAddStock();
        loadStockManagement();
      };
    }

    // ===== Sale Management =====
    function loadSaleManagement(){
      const salesTable = document.getElementById('sales-table');
      salesTable.innerHTML='';
      if(sales.length===0){ salesTable.innerHTML = '<tr><td colspan="7" class="text-center">No sales recorded yet</td></tr>'; return; }
      sales.forEach(s=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${s.invoiceId}</td><td>${s.date}</td><td>${s.customer}</td><td>${s.items.length} items</td><td>${fmtCurrency(s.totalAmount)}</td><td>${fmtCurrency(s.netProfit||0)}</td><td><button class="btn btn-sm btn-info" onclick="printInvoice(${s.invoiceId})">Print</button></td>`;
        salesTable.appendChild(tr);
      });
    }
    function filterSales(){
      const start = document.getElementById('start-date').value;
      const end = document.getElementById('end-date').value;
      if(!start || !end){ alert('Please select both start and end dates'); return; }
      const filtered = sales.filter(s=>{
        const d = new Date(s.date);
        return d >= new Date(start) && d <= new Date(end);
      });
      const salesTable = document.getElementById('sales-table');
      salesTable.innerHTML='';
      if(filtered.length===0){ salesTable.innerHTML = '<tr><td colspan="7" class="text-center">No sales in this date range</td></tr>'; return; }
      filtered.forEach(s=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${s.invoiceId}</td><td>${s.date}</td><td>${s.customer}</td><td>${s.items.length} items</td><td>${fmtCurrency(s.totalAmount)}</td><td>${fmtCurrency(s.netProfit||0)}</td><td><button class="btn btn-sm btn-info" onclick="printInvoice(${s.invoiceId})">Print</button></td>`;
        salesTable.appendChild(tr);
      });
    }
    function printFilteredSales(){
      const start = document.getElementById('start-date').value;
      const end = document.getElementById('end-date').value;
      if(!start || !end){ alert('Please select both start and end dates'); return; }
      const filtered = sales.filter(s=>{
        const d = new Date(s.date);
        return d >= new Date(start) && d <= new Date(end);
      });
      if(filtered.length===0){ alert('No sales in this date range'); return; }
      
      let printContent = `
        <div class="container mt-4">
          <h2 class="text-center">Sales Report from ${start} to ${end}</h2>
          <table class="table table-bordered mt-3">
            <thead><tr><th>Invoice #</th><th>Date</th><th>Customer</th><th>Items</th><th>Total Amount</th><th>Profit</th></tr></thead>
            <tbody>
      `;
      filtered.forEach(s=>{
        printContent += `<tr><td>${s.invoiceId}</td><td>${s.date}</td><td>${s.customer}</td><td>${s.items.length} items</td><td>${fmtCurrency(s.totalAmount)}</td><td>${fmtCurrency(s.netProfit||0)}</td></tr>`;
      });
      printContent += `
            </tbody>
          </table>
          <div class="text-end mt-4">
            <p>Total Sales: ${fmtCurrency(filtered.reduce((sum, s) => sum + s.totalAmount, 0))}</p>
            <p>Total Profit: ${fmtCurrency(filtered.reduce((sum, s) => sum + (s.netProfit||0), 0))}</p>
          </div>
        </div>
      `;
      
      const printWindow = window.open('', '_blank');
      printWindow.document.write(`
        <html><head><title>Sales Report</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
        </head><body>${printContent}</body></html>
      `);
      printWindow.document.close();
      printWindow.focus();
      setTimeout(()=>{ printWindow.print(); }, 500);
    }

    // ===== Invoice =====
    function loadInvoice(){
      const customerSelect = document.getElementById('customer-select');
      customerSelect.innerHTML = '<option value="">Select Customer</option>';
      customers.forEach(c=>{ const o=document.createElement('option'); o.value=c.id; o.textContent=c.businessName; customerSelect.appendChild(o); });

      const productSelect = document.getElementById('product-select');
      productSelect.innerHTML = '<option value="">Select Product</option>';
      stock.filter(item => item.quantity > 0).forEach(p=>{ 
        const o=document.createElement('option'); 
        o.value=p.id; 
        o.textContent=`${p.name} (${p.company}) - Stock: ${p.quantity}`; 
        productSelect.appendChild(o); 
      });

      const recentInvoicesTable = document.getElementById('recent-invoices-table');
      recentInvoicesTable.innerHTML='';
      const recentInvoices = sales.slice(-5).reverse();
      if(recentInvoices.length===0){ recentInvoicesTable.innerHTML = '<tr><td colspan="4" class="text-center">No recent invoices</td></tr>'; }
      else {
        recentInvoices.forEach(s=>{
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${s.invoiceId}</td><td>${s.date}</td><td>${fmtCurrency(s.totalAmount)}</td><td><button class="btn btn-sm btn-info" onclick="printInvoice(${s.invoiceId})">Print</button></td>`;
          recentInvoicesTable.appendChild(tr);
        });
      }
    }
    function addToInvoice(){
      const productId = parseInt(document.getElementById('product-select').value);
      const quantity = parseInt(document.getElementById('sale-quantity').value) || 1;
      if(!productId){ alert('Please select a product'); return; }
      
      const product = stock.find(p=> p.id === productId);
      if(!product){ alert('Product not found'); return; }
      if(product.quantity < quantity){ alert(`Only ${product.quantity} items available in stock`); return; }
      
      const existingItem = currentInvoiceItems.find(i=> i.id === productId);
      if(existingItem){
        if(product.quantity < existingItem.quantity + quantity){ 
          alert(`Only ${product.quantity} items available in stock`); 
          return; 
        }
        existingItem.quantity += quantity;
        existingItem.total = existingItem.quantity * existingItem.salePrice;
      } else {
        currentInvoiceItems.push({
          id: product.id,
          name: product.name,
          company: product.company,
          salePrice: product.salePrice,
          purchasePrice: product.purchasePrice,
          quantity: quantity,
          total: quantity * product.salePrice
        });
      }
      
      updateInvoiceDisplay();
      document.getElementById('product-select').value = '';
      document.getElementById('sale-quantity').value = 1;
    }
    function updateInvoiceDisplay(){
      const body = document.getElementById('invoice-items');
      body.innerHTML='';
      let total = 0;
      currentInvoiceItems.forEach((item, idx)=>{
        total += item.total;
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${item.name} (${item.company})</td>
          <td>${fmtCurrency(item.salePrice)}</td>
          <td>${item.quantity}</td>
          <td>${fmtCurrency(item.total)}</td>
          <td><button class="btn btn-sm btn-danger" onclick="removeInvoiceItem(${idx})"><i class="fas fa-trash"></i></button></td>
        `;
        body.appendChild(tr);
      });
      document.getElementById('invoice-total').textContent = fmtCurrency(total);
    }
    function removeInvoiceItem(idx){
      currentInvoiceItems.splice(idx, 1);
      updateInvoiceDisplay();
    }
    function clearInvoice(){
      currentInvoiceItems = [];
      updateInvoiceDisplay();
    }
    function processSale(){
      if(currentInvoiceItems.length === 0){ alert('No items in invoice'); return; }
      const customerId = parseInt(document.getElementById('customer-select').value);
      if(!customerId){ alert('Please select a customer'); return; }
      const customer = customers.find(c=> c.id === customerId);
      if(!customer){ alert('Customer not found'); return; }
      
      // Update stock quantities
      currentInvoiceItems.forEach(item=>{
        const stockItem = stock.find(s=> s.id === item.id);
        if(stockItem){
          // Ensure stock doesn't go negative
          if(stockItem.quantity < item.quantity) {
            alert(`Not enough stock for ${item.name}. Only ${stockItem.quantity} available.`);
            return;
          }
          stockItem.quantity -= item.quantity;
        }
      });
      
      const totalAmount = currentInvoiceItems.reduce((sum, item) => sum + item.total, 0);
      const totalCost = currentInvoiceItems.reduce((sum, item) => sum + (item.purchasePrice * item.quantity), 0);
      const netProfit = totalAmount - totalCost;
      
      const sale = {
        invoiceId: nextInvoiceId,
        date: new Date().toLocaleString(),
        customer: customer.businessName,
        customerId: customer.id,
        items: [...currentInvoiceItems],
        totalAmount,
        totalCost,
        netProfit
      };
      
      sales.push(sale);
      localStorage.setItem('sales', JSON.stringify(sales));
      localStorage.setItem('stock', JSON.stringify(stock));
      localStorage.setItem('nextInvoiceId', nextInvoiceId + 1);
      nextInvoiceId++;
      
      alert(`Sale processed successfully! Invoice #${sale.invoiceId}`);
      printInvoice(sale.invoiceId);
      clearInvoice();
      loadDashboard();
      loadStockManagement();
      loadSaleManagement();
    }
    function printInvoice(invoiceId){
      const sale = sales.find(s=> s.invoiceId === invoiceId);
      if(!sale){ alert('Invoice not found'); return; }
      
      let itemsRows = '';
      sale.items.forEach(item=>{
        itemsRows += `<tr><td>${item.name} (${item.company})</td><td>${fmtCurrency(item.salePrice)}</td><td>${item.quantity}</td><td>${fmtCurrency(item.total)}</td></tr>`;
      });
      
      const printContent = `
        <div class="container mt-4 print-area">
          <div class="row">
            <div class="col-12 text-center">
              <h2>Sindh Lab Point</h2>
              <p>Surgical Shop</p>
            </div>
          </div>
          <div class="row mt-3">
            <div class="col-6">
              <p><strong>Invoice #:</strong> ${sale.invoiceId}</p>
              <p><strong>Date:</strong> ${sale.date}</p>
            </div>
            <div class="col-6 text-end">
              <p><strong>Customer:</strong> ${sale.customer}</p>
            </div>
          </div>
          <div class="row mt-3">
            <div class="col-12">
              <table class="table table-bordered">
                <thead><tr><th>Item</th><th>Price</th><th>Qty</th><th>Total</th></tr></thead>
                <tbody>${itemsRows}</tbody>
                <tfoot><tr><th colspan="3" class="text-end">Total Amount:</th><th>${fmtCurrency(sale.totalAmount)}</th></tr></tfoot>
              </table>
            </div>
          </div>
          <div class="row mt-5">
            <div class="col-6 text-center">
              <div class="line">Customer Signature</div>
            </div>
            <div class="col-6 text-center">
              <div class="line">Authorized Signature</div>
            </div>
          </div>
          <div class="row mt-4">
            <div class="col-12 text-center">
              <p>Thank you for your business!</p>
            </div>
          </div>
        </div>
      `;
      
      const printWindow = window.open('', '_blank');
      printWindow.document.write(`
        <html><head><title>Invoice #${sale.invoiceId}</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
        </head><body>${printContent}</body></html>
      `);
      printWindow.document.close();
      printWindow.focus();
      setTimeout(()=>{ printWindow.print(); }, 500);
    }

    // ===== Accounts =====
    function initMonthYearSelectors(){
      const monthSelect = document.getElementById('accounts-month');
      const yearSelect = document.getElementById('accounts-year');
      const customerSelect = document.getElementById('accounts-customer');
      
      // Populate months
      for(let i=0; i<12; i++){
        const option = document.createElement('option');
        option.value = i;
        option.textContent = monthName(i);
        if(i === new Date().getMonth()) option.selected = true;
        monthSelect.appendChild(option);
      }
      
      // Populate years (current year and previous)
      const currentYear = new Date().getFullYear();
      for(let i=currentYear-1; i<=currentYear; i++){
        const option = document.createElement('option');
        option.value = i;
        option.textContent = i;
        if(i === currentYear) option.selected = true;
        yearSelect.appendChild(option);
      }
      
      // Populate customers
      customerSelect.innerHTML = '<option value="">All Customers</option>';
      customers.forEach(c=>{
        const option = document.createElement('option');
        option.value = c.id;
        option.textContent = c.businessName;
        customerSelect.appendChild(option);
      });
    }
    function loadAccounts(){
      const month = parseInt(document.getElementById('accounts-month').value);
      const year = parseInt(document.getElementById('accounts-year').value);
      const customerId = document.getElementById('accounts-customer').value;
      
      const accountsTable = document.getElementById('accounts-table');
      accountsTable.innerHTML = '';
      
      // Filter sales by month, year, and customer
      const filteredSales = sales.filter(s => {
        const saleDate = new Date(s.date);
        const saleMonth = saleDate.getMonth();
        const saleYear = saleDate.getFullYear();
        
        let matches = saleMonth === month && saleYear === year;
        if(customerId) matches = matches && s.customerId === parseInt(customerId);
        return matches;
      });
      
      // Group sales by customer
      const customerSales = {};
      filteredSales.forEach(sale => {
        if(!customerSales[sale.customerId]) {
          const customer = customers.find(c => c.id === sale.customerId);
          customerSales[sale.customerId] = {
            customerId: sale.customerId,
            customerName: sale.customer,
            contact: customer ? customer.phone : '',
            totalPurchases: 0,
            totalPaid: 0,
            payments: []
          };
        }
        customerSales[sale.customerId].totalPurchases += sale.totalAmount;
      });
      
      // Add payments
      payments.forEach(payment => {
        if(customerSales[payment.customerId]) {
          customerSales[payment.customerId].totalPaid += payment.amount;
          customerSales[payment.customerId].payments.push(payment);
        }
      });
      
      // Populate table
      if(Object.keys(customerSales).length === 0) {
        accountsTable.innerHTML = '<tr><td colspan="6" class="text-center">No records found for selected period</td></tr>';
        return;
      }
      
      Object.values(customerSales).forEach(account => {
        const unpaid = account.totalPurchases - account.totalPaid;
        const paymentDetails = account.payments.map(p => 
          `${new Date(p.date).toLocaleDateString()}: ${fmtCurrency(p.amount)}`
        ).join('<br>');
        
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${account.customerName}<br><small>${account.contact}</small></td>
          <td>${fmtCurrency(account.totalPurchases)}</td>
          <td>${fmtCurrency(account.totalPaid)}</td>
          <td>${fmtCurrency(unpaid)}</td>
          <td>${paymentDetails || 'No payments recorded'}</td>
          <td>
            <button class="btn btn-sm btn-info" onclick="viewCustomerProfile(${account.customerId})">Profile</button>
            <button class="btn btn-sm btn-success" onclick="recordPayment(${account.customerId})">Payment</button>
          </td>
        `;
        accountsTable.appendChild(tr);
      });
    }
    function printMonthlyStatement(){
      const month = parseInt(document.getElementById('accounts-month').value);
      const year = parseInt(document.getElementById('accounts-year').value);
      const customerId = document.getElementById('accounts-customer').value;
      const customerName = customerId ? 
        customers.find(c => c.id === parseInt(customerId))?.businessName : 'All Customers';
      
      const printArea = document.getElementById('accounts-print');
      printArea.innerHTML = `
        <div class="container mt-4">
          <h2 class="text-center">Monthly Statement - ${monthName(month)} ${year}</h2>
          <h4 class="text-center">${customerName}</h4>
          <table class="table table-bordered mt-3">
            <thead>
              <tr>
                <th>Buyer</th>
                <th>Purchases (PKR)</th>
                <th>Paid (PKR)</th>
                <th>Unpaid (PKR)</th>
                <th>Payments (dates & amounts)</th>
              </tr>
            </thead>
            <tbody>
              ${document.getElementById('accounts-table').innerHTML.replace(/<button[^>]*>.*?<\/button>/g, '')}
            </tbody>
          </table>
          <div class="text-end mt-4">
            <p>Generated on: ${new Date().toLocaleString()}</p>
          </div>
        </div>
      `;
      
      window.print();
    }
    function recordPayment(customerId){
      const customer = customers.find(c => c.id === customerId);
      if(!customer) { alert('Customer not found'); return; }
      
      const amount = prompt(`Enter payment amount for ${customer.businessName}:`);
      if(!amount || isNaN(parseFloat(amount)) || parseFloat(amount) <= 0) {
        alert('Please enter a valid amount');
        return;
      }
      
      const payment = {
        id: payments.length + 1,
        customerId: customerId,
        customerName: customer.businessName,
        amount: parseFloat(amount),
        date: new Date().toLocaleString(),
        note: `Payment recorded on ${new Date().toLocaleDateString()}`
      };
      
      payments.push(payment);
      localStorage.setItem('payments', JSON.stringify(payments));
      alert('Payment recorded successfully!');
      loadAccounts();
    }
    function viewCustomerProfile(customerId){
      const customer = customers.find(c => c.id === customerId);
      if(!customer) { alert('Customer not found'); return; }
      
      // Calculate customer stats
      const customerSales = sales.filter(s => s.customerId === customerId);
      const customerPayments = payments.filter(p => p.customerId === customerId);
      
      const totalPurchases = customerSales.reduce((sum, sale) => sum + sale.totalAmount, 0);
      const totalPaid = customerPayments.reduce((sum, payment) => sum + payment.amount, 0);
      const unpaidBalance = totalPurchases - totalPaid;
      
      // Update modal content
      document.getElementById('profile-customer-name').textContent = customer.businessName;
      document.getElementById('profile-contact-info').innerHTML = `
        ${customer.contactPerson ? `Contact: ${customer.contactPerson}<br>` : ''}
        Phone: ${customer.phone || 'N/A'}${customer.email ? `<br>Email: ${customer.email}` : ''}
      `;
      document.getElementById('profile-address').textContent = `Address: ${customer.address || 'Not provided'}`;
      
      document.getElementById('profile-total-purchases').textContent = fmtCurrency(totalPurchases);
      document.getElementById('profile-total-paid').textContent = fmtCurrency(totalPaid);
      document.getElementById('profile-total-unpaid').textContent = fmtCurrency(unpaidBalance);
      
      // Populate purchase history
      const purchaseHistory = document.getElementById('profile-purchase-history');
      purchaseHistory.innerHTML = '';
      if(customerSales.length === 0) {
        purchaseHistory.innerHTML = '<tr><td colspan="4" class="text-center">No purchases found</td></tr>';
      } else {
        customerSales.slice(-10).reverse().forEach(sale => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${sale.date}</td>
            <td>${sale.invoiceId}</td>
            <td>${fmtCurrency(sale.totalAmount)}</td>
            <td><button class="btn btn-sm btn-info" onclick="printInvoice(${sale.invoiceId})">View Invoice</button></td>
          `;
          purchaseHistory.appendChild(tr);
        });
      }
      
      // Populate payment history
      const paymentHistory = document.getElementById('profile-payment-history');
      paymentHistory.innerHTML = '';
      if(customerPayments.length === 0) {
        paymentHistory.innerHTML = '<tr><td colspan="3" class="text-center">No payments found</td></tr>';
      } else {
        customerPayments.slice(-10).reverse().forEach(payment => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${payment.date}</td>
            <td>${fmtCurrency(payment.amount)}</td>
            <td>${payment.note || 'Payment'}</td>
          `;
          paymentHistory.appendChild(tr);
        });
      }
      
      // Show modal
      const modal = new bootstrap.Modal(document.getElementById('customerProfileModal'));
      modal.show();
    }

    // ===== Customers =====
    function loadCustomers(){
      const customerList = document.getElementById('customer-list');
      customerList.innerHTML = '';
      
      if(customers.length === 0) {
        customerList.innerHTML = '<li class="list-group-item text-center">No customers found</li>';
        return;
      }
      
      customers.forEach(customer => {
        const li = document.createElement('li');
        li.className = 'list-group-item d-flex justify-content-between align-items-center';
        li.innerHTML = `
          <div>
            <strong>${customer.businessName}</strong>
            ${customer.contactPerson ? `<br><small>Contact: ${customer.contactPerson}</small>` : ''}
            ${customer.phone ? `<br><small>Phone: ${customer.phone}</small>` : ''}
          </div>
          <div>
            <button class="btn btn-sm btn-info" onclick="viewCustomerProfile(${customer.id})">Profile</button>
          </div>
        `;
        customerList.appendChild(li);
      });
    }
    function addCustomer(){
      const businessName = document.getElementById('customer-business-name').value.trim();
      const contactPerson = document.getElementById('customer-contact-person').value.trim();
      const address = document.getElementById('customer-address').value.trim();
      const phone = document.getElementById('customer-phone').value.trim();
      const email = document.getElementById('customer-email').value.trim();
      
      if(!businessName) {
        alert('Business name is required');
        return;
      }
      
      const newCustomer = {
        id: customers.length > 0 ? Math.max(...customers.map(c => c.id)) + 1 : 1,
        businessName,
        contactPerson,
        address,
        phone,
        email
      };
      
      customers.push(newCustomer);
      localStorage.setItem('customers', JSON.stringify(customers));
      
      alert('Customer added successfully!');
      
      // Clear form
      document.getElementById('customer-business-name').value = '';
      document.getElementById('customer-contact-person').value = '';
      document.getElementById('customer-address').value = '';
      document.getElementById('customer-phone').value = '';
      document.getElementById('customer-email').value = '';
      
      loadCustomers();
      loadInvoice(); // Refresh customer select in invoice page
    }

    // ===== Profit & Loss =====
    function calculateProfitLoss(){
      const period = document.getElementById('report-period').value;
      let startDate, endDate = new Date();
      
      switch(period){
        case 'today':
          startDate = new Date();
          startDate.setHours(0,0,0,0);
          break;
        case 'week':
          startDate = new Date();
          startDate.setDate(startDate.getDate() - startDate.getDay());
          startDate.setHours(0,0,0,0);
          break;
        case 'month':
          startDate = new Date();
          startDate.setDate(1);
          startDate.setHours(0,0,0,0);
          break;
        case 'year':
          startDate = new Date();
          startDate.setMonth(0, 1);
          startDate.setHours(0,0,0,0);
          break;
        case 'custom':
          startDate = new Date(document.getElementById('profit-start-date').value);
          endDate = new Date(document.getElementById('profit-end-date').value);
          if(isNaN(startDate) || isNaN(endDate)){
            alert('Please select valid custom dates');
            return;
          }
          break;
      }
      
      // Show/hide custom date range
      document.getElementById('custom-range').style.display = period === 'custom' ? 'flex' : 'none';
      
      const filteredSales = sales.filter(s => {
        const saleDate = new Date(s.date);
        return saleDate >= startDate && saleDate <= endDate;
      });
      
      let totalRevenue = 0;
      let totalCost = 0;
      let netProfit = 0;
      
      const tableBody = document.getElementById('profit-loss-table');
      tableBody.innerHTML = '';
      
      if(filteredSales.length === 0){
        tableBody.innerHTML = '<tr><td colspan="7" class="text-center">No sales in selected period</td></tr>';
      } else {
        filteredSales.forEach(sale => {
          totalRevenue += sale.totalAmount;
          totalCost += sale.totalCost;
          netProfit += sale.netProfit;
          
          sale.items.forEach(item => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${sale.date}</td>
              <td>${sale.invoiceId}</td>
              <td>${item.name} (${item.company})</td>
              <td>${item.quantity}</td>
              <td>${fmtCurrency(item.salePrice * item.quantity)}</td>
              <td>${fmtCurrency(item.purchasePrice * item.quantity)}</td>
              <td>${fmtCurrency((item.salePrice - item.purchasePrice) * item.quantity)}</td>
            `;
            tableBody.appendChild(tr);
          });
        });
      }
      
      const profitMargin = totalRevenue > 0 ? (netProfit / totalRevenue * 100) : 0;
      
      document.getElementById('total-revenue').textContent = fmtCurrency(totalRevenue);
      document.getElementById('total-cost').textContent = fmtCurrency(totalCost);
      document.getElementById('net-profit').textContent = fmtCurrency(netProfit);
      document.getElementById('profit-margin').textContent = profitMargin.toFixed(2) + '%';
    }
  </script>
</body>
</html>
